name: autodeploy

on:
  push:
    branches: [main]  # deploys only from main
  workflow_dispatch:  # allow manual triggers

permissions:
  contents: read
  packages: write
  id-token: write  # for future OIDC use (optional)

jobs:
  autodeploy:
    name: Build & Deploy Scala App
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Set up Java 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17
          cache: sbt  

      - name: Set up Sbt    
        uses: sbt/setup-sbt@v1
      # - name: Build assembly JAR
      #   run: sbt clean assembly
      #   env:
      #     SBT_OPTS: -Xmx2G

      # - name: Login to GitHub Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}

      # - name: Build and push production image
      #   uses: docker/build-push-action@v6
      #   with:
      #     context: .
      #     push: true
      #     tags: |
      #       ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
      #       ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ github.sha }}
      #     file: ./Dockerfile
      #     provenance: true  # enables SBOM/SLSA provenance
      #     sbom: true

      # - name: Deploy to Production (example)
      #   if: github.ref == 'refs/heads/main'
      #   env:
      #     IMAGE: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
      #     DEPLOY_API_KEY: ${{ secrets.PRODUCTION_DEPLOY_API_KEY }}
      #   run: |
      #     echo "Deploying $IMAGE to production..."
      #     # Example deploy command (replace with your real deployment tool)
      #     # flyctl deploy --image "$IMAGE"
      #     # kubectl set image deployment/myapp myapp=$IMAGE
